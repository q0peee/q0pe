<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>q0pe</title>

<style>
body {
  margin: 0;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
}

.box {
  background: white;
  width: 380px;
  padding: 40px 30px;
  border-radius: 20px;
  box-shadow: 0 20px 40px rgba(0,0,0,.12);
  text-align: center;
}

.logo {
  font-size: 48px;
  font-weight: bold;
  margin-bottom: 25px;
}

.profile-wrapper {
  display: flex;
  justify-content: center;
  margin-bottom: 20px;
}

.profile {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px dashed #cbd5e1;
  cursor: pointer;
}

input {
  width: 100%;
  padding: 14px;
  margin-top: 10px;
  border-radius: 12px;
  border: 1px solid #ccc;
  font-size: 15px;
}

button {
  width: 100%;
  margin-top: 14px;
  padding: 14px;
  border-radius: 12px;
  border: none;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  background: linear-gradient(135deg,#6366f1,#8b5cf6);
  color: white;
}

button.secondary {
  background: #e5e7eb;
  color: #111;
}

.small {
  font-size: 12px;
  color: #666;
  margin-top: 4px;
}
</style>
</head>

<body>
<div class="box" id="box">
  <div class="logo">q0pe</div>
  <button onclick="login()">Zaloguj się przez Google</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBlUC0MjnkhcBbWeeSV2m1qA0FUthXNOCw",
  authDomain: "q0peee.firebaseapp.com",
  projectId: "q0peee",
  appId: "1:172139799914:web:ffc02c6c3b49a3fb57b113"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
const provider = new GoogleAuthProvider();
const box = document.getElementById("box");

window.login = () => signInWithPopup(auth, provider);
window.logout = () => signOut(auth);

onAuthStateChanged(auth, async user => {
  if (!user) {
    box.innerHTML = `
      <div class="logo">q0pe</div>
      <button onclick="login()">Zaloguj się przez Google</button>
    `;
    return;
  }

  const refDoc = doc(db, "users", user.uid);
  const snap = await getDoc(refDoc);

  if (!snap.exists()) setupProfile(user, refDoc);
  else showApp(snap.data());
});

function setupProfile(user, refDoc) {
  box.innerHTML = `
    <div class="profile-wrapper">
      <img src="${user.photoURL}" class="profile" id="avatar">
    </div>
    <input type="file" id="file" accept="image/*" hidden>

    <input id="nick" placeholder="Nazwa użytkownika">
    <div class="small">Jednorazowa • 4–25 • a-z A-Z 0-9 . _</div>

    <input id="display" value="${user.displayName}">
    <div class="small">Wyświetlana nazwa (można zmienić)</div>

    <button id="save">Zapisz</button>
    <button class="secondary" onclick="logout()">Anuluj</button>
  `;

  const avatar = document.getElementById("avatar");
  const file = document.getElementById("file");
  let imgFile = null;

  avatar.onclick = () => file.click();
  file.onchange = e => {
    imgFile = e.target.files[0];
    avatar.src = URL.createObjectURL(imgFile);
  };

  document.getElementById("save").onclick = async () => {
    const nick = nick.value.trim();
    const display = display.value.trim();
    if (!/^[a-zA-Z0-9._]{4,25}$/.test(nick)) {
      alert("Zła nazwa użytkownika");
      return;
    }

    let photoURL = user.photoURL;
    if (imgFile) {
      const imgRef = ref(storage, "avatars/" + user.uid);
      await uploadBytes(imgRef, imgFile);
      photoURL = await getDownloadURL(imgRef);
    }

    await setDoc(refDoc, {
      nick,
      displayName: display,
      photoURL,
      email: user.email
    });

    showApp({ displayName: display, photoURL });
  };
}

function showApp(data) {
  box.innerHTML = `
    <div class="profile-wrapper">
      <img src="${data.photoURL}" class="profile">
    </div>
    <h2>Witaj, ${data.displayName}</h2>
    <button onclick="logout()">Wyloguj się</button>
  `;
}
</script>
</body>
</html>
