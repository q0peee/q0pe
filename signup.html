<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDocs, collection, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBl...",
  authDomain: "q0peee.firebaseapp.com",
  projectId: "q0peee",
  appId: "1:172139799914:web:ffc02c6c3b49a3fb57b113"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let user;
let selectedFile = null;
let lastNickCheck = 0; // ðŸ”¥ blokuje stare zapytania

const pic = document.getElementById("profilePic");
const file = document.getElementById("fileInput");
const nickInput = document.getElementById("nick");
const displayInput = document.getElementById("display");
const nickMessage = document.getElementById("nickMessage");
const displayMessage = document.getElementById("displayMessage");

onAuthStateChanged(auth, u => {
  if (!u) window.location.href = "login.html";
  user = u;
  pic.src = u.photoURL;
});

// avatar upload
pic.onclick = () => file.click();
file.onchange = e => {
  const f = e.target.files[0];
  if (!f) return;
  if (f.size > 10 * 1024 * 1024) {
    alert("Max 10MB");
    return;
  }
  selectedFile = f;
  pic.src = URL.createObjectURL(f);
};

// ðŸ”¥ STABILNE sprawdzanie nicku
nickInput.addEventListener("input", async () => {
  const nick = nickInput.value.trim();
  const checkId = Date.now();
  lastNickCheck = checkId;

  if (!nick) {
    nickMessage.textContent = "";
    return;
  }

  if (!/^[a-zA-Z0-9._]{4,25}$/.test(nick)) {
    nickMessage.textContent = "NieprawidÅ‚owa nazwa";
    nickMessage.className = "message error";
    return;
  }

  nickMessage.textContent = "Sprawdzanie...";
  nickMessage.className = "message";

  const q = query(collection(db, "users"), where("nick", "==", nick));
  const snap = await getDocs(q);

  // ðŸ”¥ ignoruj stare zapytania
  if (checkId !== lastNickCheck) return;

  if (!snap.empty) {
    nickMessage.textContent = "Nazwa jest zajÄ™ta";
    nickMessage.className = "message error";
  } else {
    nickMessage.textContent = "Nazwa dostÄ™pna âœ“";
    nickMessage.className = "message success";
  }
});

// display name
displayInput.addEventListener("input", () => {
  const val = displayInput.value.trim();
  if (val.length < 4) {
    displayMessage.textContent = "Min 4 znaki";
    displayMessage.className = "message error";
  } else if (val.length > 25) {
    displayMessage.textContent = "Max 25 znakÃ³w";
    displayMessage.className = "message error";
  } else {
    displayMessage.textContent = "";
  }
});

// anuluj
document.getElementById("cancelBtn").onclick = async () => {
  await signOut(auth);
  window.location.href = "login.html";
};

// zapisz
document.getElementById("saveBtn").onclick = async () => {
  const nick = nickInput.value.trim();
  const display = displayInput.value.trim();

  if (!/^[a-zA-Z0-9._]{4,25}$/.test(nick)) {
    nickMessage.textContent = "NieprawidÅ‚owa nazwa";
    nickMessage.className = "message error";
    return;
  }

  const q = query(collection(db, "users"), where("nick", "==", nick));
  const snap = await getDocs(q);
  if (!snap.empty) {
    nickMessage.textContent = "Nazwa zajÄ™ta";
    nickMessage.className = "message error";
    return;
  }

  if (display.length < 4 || display.length > 25) {
    displayMessage.textContent = "4â€“25 znakÃ³w";
    displayMessage.className = "message error";
    return;
  }

  let photoURL = user.photoURL;
  if (selectedFile) {
    const r = ref(storage, "avatars/" + user.uid);
    await uploadBytes(r, selectedFile);
    photoURL = await getDownloadURL(r);
  }

  await setDoc(doc(db, "users", user.uid), {
    nick,
    displayName: display,
    photoURL,
    email: user.email
  });

  window.location.href = "app.html";
};
</script>
