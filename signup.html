<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>q0pe – konfiguracja profilu</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@500;700&display=swap" rel="stylesheet">

  <style>
   body {
      margin:0;
      height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      font-family:'Nunito',sans-serif;
      background:#eee;
    }

    .background {
      position:fixed;
      inset:0;
      background:radial-gradient(circle at 50% 50%, #ffffff, #656466);
      z-index:-1;
      transition:background .1s;
    }

    .box {
      width:380px;
      background:#fff;
      border-radius:22px;
      padding:30px;
      box-shadow:0 15px 40px rgba(0,0,0,.25);
    }

    .top {
      text-align:center;
      margin-bottom:20px;
    }

    .profile {
      width:110px;
      height:110px;
      border-radius:50%;
      object-fit:cover;
      border:3px dashed #ccc;
      cursor:pointer;
    }

    h2 { margin:15px 0 5px; }

    label {
      font-weight:700;
      display:block;
      margin-top:16px;
    }

    input {
      width:100%;
      padding:12px;
      margin-top:6px;
      border-radius:12px;
      border:1px solid #ccc;
      font-size:15px;
      box-sizing:border-box;
    }

    .rules {
      font-size:12px;
      color:#999;
      margin-top:4px;
    }

    .rules .fixed {
      display:block;
      margin-top:2px;
      font-weight:700;
      color:#555;
    }

    .message {
      font-size:12px;
      margin-top:4px;
      min-height:16px;
    }

    .error { color:red; }
    .success { color:green; }

    .buttons {
      display:flex;
      gap:10px;
      margin-top:22px;
    }

    button {
      flex:1;
      padding:12px;
      border-radius:12px;
      border:none;
      font-weight:700;
      cursor:pointer;
      font-size:15px;
    }

    .save { background:#00d440; }
    .cancel { background:#ddd; }
  </style>
</head>

<body>
<div class="background"></div>

<div class="box">
  <div class="top">
    <img id="profilePic" class="profile">
    <input type="file" id="fileInput" accept="image/*,image/gif" hidden>
    <h2>Utwórz profil</h2>
  </div>

  <label>Nazwa użytkownika</label>
  <input id="nick" placeholder="Wybież swoją nazwę">
  <div class="rules">(a-z A-Z 0-9 . _ • min 4 • max 25)
    <span class="fixed">Tej nazwy nie można zmienić</span>
  </div>
  <div id="nickMessage" class="message"></div>

  <label>Wyświetlana nazwa</label>
  <input id="display" placeholder="Wpisz swoją wyświetlaną nazwę">
  <div class="rules">(min 4 • max 25 • dowolne znaki)</div>
  <div id="displayMessage" class="message"></div>

  <div class="buttons">
    <button class="save" id="saveBtn">Kontynuuj</button>
    <button class="cancel" id="cancelBtn">Anuluj</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBlUC0MjnkhcBbWeeSV2m1qA0FUthXNOCw",
    authDomain: "q0peee.firebaseapp.com",
    projectId: "q0peee",
    appId: "1:172139799914:web:ffc02c6c3b49a3fb57b113"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  let user;
  let selectedFile = null;

  const pic = document.getElementById("profilePic");
  const file = document.getElementById("fileInput");
  const nickInput = document.getElementById("nick");
  const displayInput = document.getElementById("display");
  const nickMessage = document.getElementById("nickMessage");
  const displayMessage = document.getElementById("displayMessage");

  onAuthStateChanged(auth, u => {
    if (!u) location.href = "index.html";
    user = u;
    pic.src = u.photoURL || "https://i.imgur.com/0y0y0y0.png";
  });

  pic.onclick = () => file.click();

  file.onchange = e => {
    const f = e.target.files[0];
    if (!f) return;
    if (f.size > 10 * 1024 * 1024) {
      alert("Max 10 MB");
      return;
    }
    selectedFile = f;
    const r = new FileReader();
    r.onload = ev => pic.src = ev.target.result;
    r.readAsDataURL(f);
  };

  nickInput.addEventListener("input", async () => {
    const nick = nickInput.value.trim();

    if (nick === "") {
      nickMessage.textContent = "Wybierz nazwę";
      nickMessage.className = "message error";
      return;
    }

    if (!/^[a-zA-Z0-9._]{4,25}$/.test(nick)) {
      nickMessage.textContent = "Nieprawidłowa nazwa";
      nickMessage.className = "message error";
      return;
    }

    const snap = await getDoc(doc(db, "nicks", nick));
    if (snap.exists()) {
      nickMessage.textContent = "Nazwa jest już zajęta";
      nickMessage.className = "message error";
    } else {
      nickMessage.textContent = "Nazwa dostępna";
      nickMessage.className = "message success";
    }
  });

  displayInput.addEventListener("input", () => {
    const v = displayInput.value.trim();
    if (!v) displayMessage.textContent = "Wpisz swoją wyświetlaną nazwę";
    else if (v.length < 4) displayMessage.textContent = "Za krótka nazwa";
    else if (v.length > 25) displayMessage.textContent = "Za długa nazwa";
    else displayMessage.textContent = "";
    displayMessage.className = "message error";
  });

  document.getElementById("cancelBtn").onclick = async () => {
    await signOut(auth);
    location.href = "index.html";
  };

  document.getElementById("saveBtn").onclick = async () => {
    const nick = nickInput.value.trim();
    const display = displayInput.value.trim();

    const snap = await getDoc(doc(db, "nicks", nick));
    if (snap.exists()) {
      nickMessage.textContent = "Nazwa jest już zajęta";
      return;
    }

    let photoURL = user.photoURL;
    if (selectedFile) {
      const r = ref(storage, "avatars/" + user.uid);
      await uploadBytes(r, selectedFile);
      photoURL = await getDownloadURL(r);
    }

    await setDoc(doc(db, "nicks", nick), { uid: user.uid });
    await setDoc(doc(db, "users", user.uid), {
      nick,
      displayName: display,
      photoURL,
      email: user.email
    });

    location.href = "app.html";
  };
</script>

<script>
  const bg = document.querySelector('.background');
  document.addEventListener('mousemove', e => {
    const x = e.clientX / innerWidth * 100;
    const y = e.clientY / innerHeight * 100;
    bg.style.background = `radial-gradient(circle at ${x}% ${y}%, #fff, #656466)`;
  });
</script>
</body>
</html>
 
